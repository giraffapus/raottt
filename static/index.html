<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>RAOTTT</title>

	<script src="vendor/jquery-1.11.2.min.js"></script>
	<script src="vendor/jquery-ui.js"></script>
	<script src="vendor/jquery.ui.touch-punch.js"></script>
	<script src="vendor/jquery.rest.min.js"></script>
	<script src="vendor/jquery.cookie.js"></script>
	<script src="vendor/slidebars.min.js"></script>
	<script src="vendor/jquery.popupoverlay.js"></script>

	<link rel="stylesheet" href="vendor/font-awesome-4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="vendor/slidebars.min.css">


	<style type="text/css">

	.stats {
		position: absolute;
		top: 0;
		left: 0;
		border: 1px solid Green;
		height: 100px;
		font-family: Verdana;
	}

	.overlay {
	    background-color: #000;
	    bottom: 0;
	    display: none;
	    left: 0;
	    opacity: 0.3;
	    filter: alpha(opacity = 30); /* IE7 & 8 */
	    position: fixed;
	    right: 0;
	    top: 0;
	    z-index: 99;
	}

	#Board {
		position: absolute;
		top: 50px;
	}

	.tile {
	    position: absolute;
	    border: 1px dashed LightGray;
	    z-index: 1;
	}

	.benchTile {
		position: absolute;
		z-index: 1;
		border: 1px solid Yellow;
	}

	.piece {
	    position: absolute;
	    z-index: 2;	
	    font-family: Verdana;
	    color: White;
	    text-align: center;
	    vertical-align:middle;
	}

	.Red {
		background-color: DarkRed;
	}

	.Blue {
		background-color: DarkBlue;
	}

	.draggable {
	}

	.droppable {
	}

	.drop-hover {
		border: 1px solid Black;
	}

	.padding {
		padding: 5px;
	}

	.iconButton {
		height: 50px;
		float: right;
	}

	.right {
		float: right;
	}

	.left {
		float: left;
	}

	.occupied {
	}

	#Score {
		height: 50px;
		float: left;
		font-family: Verdana;
		font-size: 28px;
	}

	#my_popup {
		background-color: White;
		border: 1px solid Black;
		font-family: Verdana;
		font-size: 14px;
		line-height: 18px;
		padding: 20px;
		margin: 20px;
	}

	</style>

	<script>
		var restClient = undefined;
		var userToken = undefined;
		var gameId = undefined;
		var moveSource = undefined;
		var moveTarget = undefined;
		var sizes = undefined;
		var playerColor = undefined;
		var showWelcome = false;
		var score = 0;

        $(function() {
        	$.removeCookie('token');
        	showWelcome = true;

        	// Roslin Institute is where Dolly the Sheep was cloned. Here, the
        	// Roslin div is the source from which all the playing pieces are 
        	// cloned.
        	$("#Roslin").hide(0);

        	// Overlay is used to blank out the board while getting a new game
        	// from the server.
        	$("#Overlay").hide(0);

			setupSideBar();

        	initRestInterface();

	       	sizes = calculateSizeFactors(window.innerWidth, window.innerHeight);

	       	positionBoard(sizes);
        	layoutBoard(sizes.tile, sizes.padding);

        	getUserToken().pipe(resetBoard);
        });


		function initRestInterface() {
        	restClient = new $.RestClient('http://127.0.0.1:8888/');
			restClient.add('game');
			restClient.add('player');
		}


		function getUserToken() {
			console.log("getUserToken called")
			var deferred = $.Deferred();

			var token = $.cookie('token');
			if(token) {
				var request = restClient.player.read(token);
				request.done(function(data) {
					$.cookie('name', data.name);
					$.cookie('color', data.color);
					$('#HelpText').html(returnAnonGreeting(
						$.cookie('name'), $.cookie('color'), data.score));
					userToken = data.token;
					score = data.score;
					deferred.resolve(data.token);
				});
			} else {
				var request = restClient.player.create();
				request.done(function(data){
					$.cookie('token', data.token);
					$.cookie('name', data.name);
					$.cookie('color', data.color);
					$('#HelpText').html(firstTimeGreeting(
						$.cookie('name'), $.cookie('color')));
					userToken = data.token;
					deferred.resolve(data.token);
				});
			}

			return deferred.promise();
		}

		function getGame(token) {
			console.log("getGame called with token %o", token);
			var deferred = $.Deferred();

			// if($.cookie('game')) {
			// 	deferred.resolve($.cookie('game'));
			// }

			if(!token) {
				token = $.cookie('token');
			}

			var request = restClient.game.read(token);
			request.done(function(data){
				// $.cookie('game', data.token);
				gameId = data.ugid;
				playerColor = data.nextPlayer;
				deferred.resolve(data);
			});

			return deferred.promise();
		}


        function calculateSizeFactors(wWidth, wHeight)
        {
        	wHeight -= 50;
        	var windowSize = wWidth < wHeight ? wWidth : wHeight;

        	// Everything is based of the tilesize. For consistency, we want it
        	// to be an even number.
        	var tileSize = Math.floor(windowSize / 3.2);
        	tileSize = tileSize % 2 ? tileSize - 1 : tileSize;

        	// console.log("wHeight:" + wHeight + 
        	// 	        " wWidth:" + wWidth +
        	// 	        " tileSize:" + tileSize);

        	s = {};
        	s.tile = tileSize;
        	s.font = Math.floor(tileSize * 0.75);
        	s.padding = Math.floor(tileSize / 40);
        	s.padding = s.padding % 2 ? s.padding + 1 : s.padding;
        	s.board = 4 * s.padding + 3 * s.tile;
        	s.offset = wWidth / 2 - s.board / 2;
        	s.radius = Math.floor(tileSize / 15);
        	return s;
        };


        function positionBoard(sizes) {
        	// $(".board").css("top", 100);
        	$("#Board").css("left", sizes.offset);
        	$("#Board").css("width", sizes.board);

        	$("#Stats").css("left", sizes.offset);
        	$("#Stats").css("width", sizes.board);
        };


        function resetBoard(token) {
        	// First we have to remove all the pieces from the previous game
        	// and set remove the droppable class from the tiles
        	$(".piece").remove();
        	$(".tile").each(function(){
    			$(this).removeClass("droppable");
        	});

        	getGame(token).pipe(
				addPieces).pipe(
    				scalePieces).pipe(
    					setupInteraction).pipe(
    						showStats);
        }

        function addPieces(data) {
        	console.log("addPieces called with %o", data);

        	function add(i, color, count, movable) {
				var div = $("#Roslin").clone();
				div.attr("data-source", i);
				div.attr("data-color", color);
				var pos = calculatePosition(i);
				div.css("top", pos.top);
				div.css("left", pos.left);
				div.html(count);
				div.addClass("piece");
				div.addClass("occupied");
				div.addClass(color);
				if(movable) {
					div.addClass("draggable");
				}
				div.show();
				$("#Board").append(div);
        	};

        	$(data.board).each(function(i) {
        		if(data.board[i].color) {
        			var piece = data.board[i];
        			add(i, piece.color, piece.count, piece.movable);
        			removeDropForThisTile(i);
        		} else {
        			if(data.offBoard) {
			        	var tile = $(".tile")[i];
			        	$(tile).click(function(){
			        		add(i, data.nextPlayer, 5, false);
			        		processMove(data.nextPlayer, -1, i);
			        	});
        			} else {
        				addDropForThisTile(i);
        			}
        		}
        	});

        	return data;
        }


        function addDropForThisTile(i) {
        	var tile = $(".tile")[i];
        	$(tile).addClass("droppable");
        };


        function removeDropForThisTile(i) {
        	var tile = $(".tile")[i];
        	$(tile).removeClass("droppable");
        };


        function scalePieces(data) {
        	console.log("scalePieces called");
        	$(".piece").each(function(i) {
        		$(this).css("width", sizes.tile - sizes.padding);
        		$(this).css("height", sizes.tile - sizes.padding);
        		$(this).css("font-size", sizes.font);
        		$(this).css("border-radius", sizes.radius);
        	});

        	return data;
        };


        function layoutBoard(tileSize, padding) {
        	$(".tile").each(function(i) {
	        	$(this).css("width", tileSize);
	        	$(this).css("height", tileSize);

	        	var col = i % 3;
	        	var row = Math.floor(i/3);

	        	$(this).css("left", padding * (col + 1) + col * tileSize);
	        	$(this).css("top",  padding * (row + 1) + row * tileSize);
	        	$(this).attr("data-target", i);
	        });
        };


        function calculatePosition(i) {
        	var tile = undefined;

        	if(i === -1) {
				tile = $(".benchTile")[0];
			} else {
				tile = $(".tile")[i];
			}

        	return {left: parseInt(tile.style.left) + sizes.padding - 1, 
        	        top:  parseInt(tile.style.top)  + sizes.padding - 1};
        };


        function processMove(color, source, target) {
			$('#Overlay').show();

        	console.log(color + " moved from " + source + " to " + target);

        	var obj = {token: $.cookie('token'),  // userToken,
        	           gameId: gameId,
        	           color: color,
        	           source: source,
        	           target: target};

        	console.log("PUTing back to server %o", obj);

        	restClient.game.update(gameId, obj).done(function(data) {
        		console.log("Response from PUT %o", data);
        		
        		$.removeCookie('game');
        		$("#ScoreNumber").html(data.score);

        		if(data.displayMsg) {
        			alert(data.message);
        		}
        		
        		resetBoard(userToken);	
        	});
        }


        function setupInteraction(data) {
        	console.log("setupInteraction called");

			$(".occupied").each(function() {
        		if($(this).droppable()) {
	        		$(this).droppable('disable');
	        	}

        		$(this).unbind('click');
			});

			// If we have all 6 pieces on the board, then we need to unbind
			// the click handler from all pieces
			if(!data.offBoard) {
				$(".tile").unbind('click');
			}

        	$(".draggable").draggable({
        		revertDuration: 200,
        		zIndex: 100,
        		cursor: "crosshair",
        		revert: function(event, ui) { 
        			if(event) {
        				return false;
        			}
        			return true;
        		}
        	});

        	$(".droppable").droppable({
  				accept: ".draggable",
  				hoverClass: "drop-hover",
  				drop: function(event, ui) {
  					var sourceTile = $(ui.draggable).attr("data-source");
  					var targetTile = $(this).attr("data-target");
  					var color = $(ui.draggable).attr("data-color");

  					$(ui.draggable).css('top',
  						$(this).position().top + sizes.padding-1);
   					$(ui.draggable).css('left',
   						$(this).position().left + sizes.padding-1);

   					processMove(color, sourceTile, targetTile);
  				}
			});

			return data;
        }

    	function showStats(data) {
    		console.log("showStats called");
    		
    		if(showWelcome) {
    			$("#my_popup").popup('show');
    			showWelcome = false;
    		}

    		$("#Overlay").hide(0);
    	};	

    	function firstTimeGreeting(name, color) {
    		var txt = "Hello anonymous person, I shall call you " + name + " (it is much more personal, don't you think?)<br><br>You will play for the " + color + " team.<br><br>If you wish to play in a network, or for a different team, or on multiple devices, then you will have to login.";
    		return txt;
    	}

    	function returnAnonGreeting(name, color, score) {
    		var txt = "Welcome back " + name + " (remember that I gave you a name when you first stopped by ...).<br><br>You are still playing for the " + color + " team.<br><br>You have " + score + " points!";
    		return txt;
    	}


    	function setupSideBar() {
	    	var settingsSidebar = new $.slidebars();
        	settingsSidebar.slidebars.close();

        	$("#ToggleSlidebar").click(function() {
        		if(settingsSidebar.slidebars.active('right')) {
        			settingsSidebar.slidebars.close();	
        		} else {
        			settingsSidebar.slidebars.open('right');
        		}
        	});
    	}


    	function setupHelpPopup() {
        	$('#my_popup').popup({
				opacity: 0.3,
				transition: 'all 0.3s'
				});    		
    	}


    	function showHelpPopup(txt) {
    		$('#HelpText').html(txt);
    		$('#my_popup').popus('show');
    	}

    </script>

</head>

<body>

<div id="sb-site">
	<div id="ToggleSlidebar" class="fa fa-arrow-circle-o-left right fa-3x padding"></div>

	<div id="ShowHelp" class="fa fa-question-circle fa-3x right padding my_popup_open"></div>

	<div id="Score" class="padding">Score: <span id="ScoreNumber">0</span></div>

	<div id="Board" class="board">
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>

		<div id="Roslin" class="ui-widget-content"></div>
		<div id="Overlay" class="ui-widget-content overlay"></div>
	</div>

	<div id="my_popup">
		<div id="HelpText">Text Goes Here</div>
		<div>
			<button class="my_popup_close right">Lets Play!</button>
			<button class="left">Login First</button>
		</div>
	</div>

	<div class="sb-slidebar sb-style-overlay sb-right sb-momentum-scrolling">
		<div class="fa fa-arrow-circle-o-right fa-inverse fa-3x padding"></div>
	</div>

</div>

</body>
</html>