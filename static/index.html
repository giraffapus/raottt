<!DOCTYPE html>
<html>
<head>

	<title>RAOTTT</title>

	<script src="vendor/jquery-1.11.2.min.js"></script>
	<script src="vendor/jquery-ui.js"></script>
	<script src="vendor/jquery.ui.touch-punch.js"></script>
	<script src="vendor/jquery.rest.min.js"></script>
	<script src="vendor/jquery.cookie.js"></script>

	<style type="text/css">

	.board {
		position: absolute;
	}

	.tile {
	    position: absolute;
	    border: 1px dashed DarkGray;
	    z-index: 1;
	}

	.benchTile {
		position: absolute;
		z-index: 1;
		border: 1px solid Yellow;
	}

	.piece {
	    position: absolute;
	    z-index: 2;	
	    font-family: Verdana;
	    color: White;
	    text-align: center;
	    vertical-align:middle;
	}

	.score {
		position: absolute;
		width: 615px;
		height: 190px;
		border: 1px dashed Gray;
	}

	.Red {
		background-color: Green;
	}

	.Blue {
		background-color: Purple;
	}

	.draggable {
	}

	.droppable {
	}

	.drop-hover {
		border: 1px solid Black;
	}

	</style>

	<script>
		var restClient = undefined;
		var userToken = undefined;
		var gameId = undefined;
		var moveSource = undefined;
		var moveTarget = undefined;
		var sizes = undefined;

        $(function() {
        	$.removeCookie('token');

        	// Roslin Institute is where Dolly the Sheep was cloned. Here, the
        	// Roslin div is the source from which all the playing pieces are 
        	// cloned.
        	$("#Roslin").hide(0);

        	initRestInterface();

	       	sizes = calculateSizeFactors(window.innerWidth, window.innerHeight);

	       	positionBoard(sizes);
        	layoutBoard(sizes.tile, sizes.padding);

        	getUserToken().pipe(getGame).pipe(addPieces).pipe(scalePieces).pipe(setupInteraction);
        });


		function initRestInterface() {
        	restClient = new $.RestClient('http://127.0.0.1:8888/');
			restClient.add('game');
			restClient.add('player');
		}


		function getUserToken() {
			var deferred = $.Deferred();

			var token = $.cookie('token');
			if(token) {
				userToken = token;
				deferred.resolve(token);
			}

			var request = restClient.player.create();
			request.done(function(data){
				$.cookie('token', data.token);
				userToken = data.token;
				deferred.resolve(data.token);
			});

			return deferred.promise();
		}

		function getGame(token) {
			var deferred = $.Deferred();

			var request = restClient.game.read(token);
			request.done(function(data){
				gameId = data.ugid;
				deferred.resolve(data);
				console.log("Game: %o", data);
			});

			return deferred.promise();
		}


        function calculateSizeFactors(wWidth, wHeight)
        {
        	var windowSize = wWidth < wHeight ? wWidth : wHeight;

        	// Everything is based of the tilesize. For consistency, we want it
        	// to be an even number, and we cap it at 160 for large displays.
        	var tileSize = Math.floor(windowSize / 3.5);
        	tileSize = tileSize % 2 ? tileSize - 1 : tileSize;
        	tileSize = tileSize > 160 ? 160 : tileSize;

        	s = {};
        	s.tile = tileSize;
        	s.font = Math.floor(tileSize * 0.75);
        	s.padding = Math.floor(tileSize / 40);
        	s.padding = s.padding % 2 ? s.padding + 1 : s.padding;
        	s.board = 4 * s.padding + 3 * s.tile;
        	s.offset = wWidth / 2 - s.board / 2;
        	s.radius = Math.floor(tileSize / 15);
        	return s;
        };


        function positionBoard(sizes) {
        	$(".board").css("left", sizes.offset);
        	$(".board").css("width",  sizes.board);
        };


        function clearBoard() {
        	$(".piece").remove();
        }

        function addPieces(data) {
        	function add(i, color, count, movable) {
				var div = $("#Roslin").clone();
				div.attr("data-source", i);
				div.attr("data-color", color);
				var pos = calculatePosition(i);
				div.css("top", pos.top);
				div.css("left", pos.left);
				div.html(count);
				div.addClass(color);
				if(movable) {
					div.addClass("draggable");
				}
				div.show();
				$(".board").append(div);
        	};

        	$(data.board).each(function(i) {
        		if(data.board[i].color) {
        			add(i, data.board[i].color, data.board[i].count, data.board[i].movable);
        		} else {
        			addDropForThisTile(i);
        		}
        	});

        	if(data.offBoard) {
        		add(-1, data.nextPlayer, "", true);
        	}
        };


        function addDropForThisTile(i) {
        	var tile = $(".tile")[i];
        	$(tile).addClass("droppable");
        };


        function scalePieces() {
        	$(".piece").each(function(i) {
        		$(this).css("width", sizes.tile - sizes.padding);
        		$(this).css("height", sizes.tile - sizes.padding);
        		$(this).css("font-size", sizes.font);
        		$(this).css("border-radius", sizes.radius);
        	});
        };


        function layoutBoard(tileSize, padding) {
        	$(".tile").each(function(i) {
	        	$(this).css("width", tileSize);
	        	$(this).css("height", tileSize);

	        	var col = i % 3;
	        	var row = Math.floor(i/3);

	        	$(this).css("left", padding * (col + 1) + col * tileSize);
	        	$(this).css("top",  padding * (row + 1) + row * tileSize);
	        	$(this).attr("data-target", i);
	        });

        	$(".benchTile").css("width", tileSize);
        	$(".benchTile").css("height", tileSize);
        	$(".benchTile").css("left", 2 * padding + 1 * tileSize);
			$(".benchTile").css("top", 5 * padding + 3 * tileSize + 10);
        };


        function calculatePosition(i) {
        	var tile = undefined;

        	if(i === -1) {
				tile = $(".benchTile")[0];
			} else {
				tile = $(".tile")[i];
			}

        	return {left: parseInt(tile.style.left) + sizes.padding - 1, 
        	        top:  parseInt(tile.style.top)  + sizes.padding - 1};
        };


        function processMove(color, source, target) {
        	console.log(color + " moved from " + source + " to " + target);

        	var obj = {token: userToken,
        	           gameId: gameId,
        	           color: color,
        	           source: source,
        	           target: target};

        	restClient.game.update(gameId, obj).done(function(data) {
        		console.log("Update returned %o", data);
        		
        		if(data.displayMsg) {
        			alert(data.message);
        		}
        		
        		location.reload();
        	});

        	// clearBoard();
        }


        function setupInteraction() {
        	$(".draggable").draggable({
        		revertDuration: 200,
        		zIndex: 100,
        		cursor: "crosshair",
        		revert: function(event, ui) { 
        			if(event) {
        				return false;
        			}
        			return true;
        		}
        	});

        	$(".droppable").droppable({
  				accept: ".draggable",
  				hoverClass: "drop-hover",
  				drop: function(event, ui) {
  					var sourceTile = $(ui.draggable).attr("data-source");
  					var targetTile = $(this).attr("data-target");
  					var color = $(ui.draggable).attr("data-color");

  					$(ui.draggable).css('top',
  						$(this).position().top + sizes.padding-1);
   					$(ui.draggable).css('left',
   						$(this).position().left + sizes.padding-1);

   					processMove(color, sourceTile, targetTile);
  				}
			});        	
        };


    </script>

</head>

<body bgcolor>
	<div id="board" class="board">
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>
		<div class="ui-widget-content tile"></div>

		<div class="ui-widget-content benchTile"></div>
		<div id="Roslin" class="ui-widget-content piece"></div>
 	</div>


</body>
</html>